/**
 * Template Metadata Generator
 * 
 * Generates template.json with placeholder definitions and project type information.
 */

/** @typedef {import('@m5nv/create-scaffold/types/template-schema').TemplateManifest} TemplateManifest */

export class MetadataGenerator {
  constructor() {
    // No initialization needed
  }

  async generateMetadata(analysis, options) {
    const { projectType, placeholders, targetFiles } = analysis;

    // Collect all files that have placeholders (including dynamically discovered JSX files)
    const allFilesWithPlaceholders = new Set(targetFiles);
    for (const placeholder of placeholders) {
      for (const file of placeholder.files) {
        allFilesWithPlaceholders.add(file);
      }
    }

    // Deduplicate placeholders by name, keeping the first occurrence
    const uniquePlaceholders = [];
    const seenNames = new Set();
    for (const p of placeholders) {
      if (!seenNames.has(p.name)) {
        seenNames.add(p.name);
        uniquePlaceholders.push(p);
      }
    }

    // Create placeholder definitions for template.json
    // Note: template.json schema requires placeholder names to be in {{NAME}} format
    const placeholderDefinitions = uniquePlaceholders.map(p => {
      const def = {
        name: `{{${p.name}}}`,
        description: this.getPlaceholderDescription(p.name),
        required: this.isPlaceholderRequired(p.name),
        type: "string",
        sensitive: false
      };
      const defaultValue = this.getPlaceholderDefault(p.name);
      if (defaultValue !== null) {
        def.default = defaultValue;
      }
      return def;
    });

    const supportedOptions = this.getSupportedOptions(projectType);
    const templateName = this.getTemplateName(projectType);
    const templateHandle = this.getTemplateHandle(projectType);
    const metadata = {
      name: templateName,
      handle: templateHandle,
      description: `A ${projectType} project template generated by @m5nv/make-template`,
      handoff: this.getHandoffSteps(projectType),
      setup: {
        authoringMode: "wysiwyg",
        supportedOptions: supportedOptions,
        dimensions: {
          features: {
            type: "multi",
            values: supportedOptions,
            description: "Select the features to include in your project"
          }
        }
      },
      metadata: {
        type: projectType,
        version: "1.0.0",
        placeholders: placeholderDefinitions,
        files: Array.from(allFilesWithPlaceholders),
        createdBy: "@m5nv/make-template",
        createdAt: new Date().toISOString()
      }
    };

    return JSON.stringify(metadata, null, 2);
  }

  getPlaceholderDescription(placeholderName) {
    const descriptions = {
      'PROJECT_NAME': 'The name of the project',
      'PROJECT_DESCRIPTION': 'A brief description of the project',
      'AUTHOR': 'The author or maintainer of the project',
      'README_TITLE': 'The title shown in the README file',
      'WORKER_NAME': 'The name of the Cloudflare Worker',
      'CLOUDFLARE_ACCOUNT_ID': 'Your Cloudflare account ID',
      'BASE_URL': 'The base URL for the Vite application',
      'HTML_TITLE': 'The title shown in the browser tab',
      'COMPANY_NAME': 'The name of the company or brand',
      'TAGLINE': 'A short tagline or slogan',
      'LOGO_URL': 'URL of the company logo image',
      'ALT_TEXT_0': 'Alternative text for the first image',
      'ALT_TEXT_1': 'Alternative text for the second image',
      'ALT_TEXT_2': 'Alternative text for the third image',
      'LINK_URL_0': 'URL for the first link',
      'LINK_URL_1': 'URL for the second link',
      'LINK_URL_2': 'URL for the third link',
      'IMAGE_URL_0': 'URL for the first image',
      'IMAGE_URL_1': 'URL for the second image',
      'IMAGE_URL_2': 'URL for the third image',
      'QUOTE_0': 'The first quote or testimonial text',
      'QUOTE_1': 'The second quote or testimonial text',
      'QUOTE_2': 'The third quote or testimonial text',
      'TEXT_CONTENT_0': 'General text content from JSX',
      'TEXT_CONTENT_1': 'Additional text content from JSX',
      'TEXT_CONTENT_2': 'More text content from JSX'
    };

    return descriptions[placeholderName] || `Value for ${placeholderName}`;
  }

  isPlaceholderRequired(placeholderName) {
    const requiredPlaceholders = [
      'PROJECT_NAME',
      'WORKER_NAME',
      'CLOUDFLARE_ACCOUNT_ID'
    ];

    return requiredPlaceholders.includes(placeholderName);
  }

  getPlaceholderDefault(placeholderName) {
    const defaults = {
      'PROJECT_DESCRIPTION': null,
      'AUTHOR': 'Your Name',
      'README_TITLE': null,
      'BASE_URL': '/',
      'HTML_TITLE': 'My App',
      'WORKER_NAME': null,
      'CLOUDFLARE_ACCOUNT_ID': 'your-account-id',
      'D1_BINDING_0': 'DB',
      'D1_DATABASE_BINDING': 'DB',
      'D1_DATABASE_ID_0': 'your-database-id',
      'D1_DATABASE_ID': 'your-database-id',
      'REPOSITORY_URL': null,
      'COMPANY_NAME': null,
      'TAGLINE': 'Welcome',
      'LOGO_URL': 'https://example.com/logo.png',
      'ALT_TEXT_0': 'Logo',
      'ALT_TEXT_1': 'Image 1',
      'ALT_TEXT_2': 'Image 2',
      'LINK_URL_0': 'https://example.com',
      'LINK_URL_1': 'https://example.com/page1',
      'LINK_URL_2': 'https://example.com/page2',
      'IMAGE_URL_0': 'https://example.com/image1.png',
      'IMAGE_URL_1': 'https://example.com/image2.png',
      'IMAGE_URL_2': 'https://example.com/image3.png',
      'QUOTE_0': 'Great product!',
      'QUOTE_1': 'Excellent service!',
      'QUOTE_2': 'Highly recommended!',
      'TEXT_CONTENT_0': 'Content 0',
      'TEXT_CONTENT_1': 'Content 1',
      'TEXT_CONTENT_2': 'Content 2'
    };

    return defaults[placeholderName] || null;
  }

  getSupportedOptions(projectType) {
    const optionsByType = {
      'cf-d1': ['database', 'auth', 'cors'],
      'cf-turso': ['database', 'auth', 'cors'],
      'vite-react': ['typescript', 'testing', 'eslint', 'prettier'],
      'generic': ['testing', 'eslint', 'prettier', 'docs']
    };

    return optionsByType[projectType] || ['testing', 'docs'];
  }

  getHandoffSteps(projectType) {
    const stepsByType = {
      'cf-d1': ['npm install', 'wrangler deploy'],
      'cf-turso': ['npm install', 'wrangler deploy'],
      'vite-react': ['npm install', 'npm run dev'],
      'generic': ['npm install']
    };

    return stepsByType[projectType] || ['npm install'];
  }

  getTemplateName(projectType) {
    const namesByType = {
      'cf-d1': 'Cloudflare Worker with D1 Database',
      'cf-turso': 'Cloudflare Worker with Turso Database',
      'vite-react': 'Vite React Application',
      'generic': 'Node.js Application'
    };

    return namesByType[projectType] || 'Generated Template';
  }

  getTemplateHandle(projectType) {
    const displayName = this.getTemplateName(projectType);
    // Convert display name to kebab-case handle
    return displayName
      .toLowerCase()
      .replace(/[^a-z0-9\s-]/g, '') // Remove special characters except spaces and hyphens
      .replace(/\s+/g, '-') // Replace spaces with hyphens
      .replace(/-+/g, '-') // Replace multiple hyphens with single hyphen
      .replace(/^-|-$/g, ''); // Remove leading/trailing hyphens
  }
} export default MetadataGenerator;